<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/static/images/spes-logo.png" type="image/png" />
    <title>DigiSPES</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css"
    />
    <style>
      /* this is needed to make the content scrollable on larger screens */
      @media (min-width: 576px) {
        .h-sm-100 {
          height: 100%;
        }
      }

      .spes-logo-img {
        width: 50px;
      }
      #logo-name {
        margin-left: 0.5rem;
        font-size: 1.5rem;
        font-weight: bold;
      }
      #sidebar {
        box-shadow: 2px 4px 6px rgba(0, 0, 0, 0.1);
      }
      #card-body {
        background-color: #006edc;
        border-radius: 0.5rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .card-link {
        text-decoration: none;
        padding: 0.7rem 1rem;
        border-radius: 0.5rem;
        border: 1px solid white;
        background-color: white;

        &:hover {
          background-color: #006edc;
          color: white;
          border: 1px solid white;
        }
      }
      .main-container {
        background-color: rgb(239, 243, 255);
        padding: 1rem;
        border-radius: 0.25rem;
      }
      #sidebar-active {
        background-color: #006edc;
        color: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: background-color 0.3s ease, color 0.3s ease;
        padding: 0.5rem 1rem;
      }
      .chat-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        background-color: #f8f9fa;
      }

      .bot-message {
        background-color: #f0f2f5;
        border-radius: 15px 15px 15px 0;
      }

      .bot-message .faq-options {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .bot-message .faq-btn {
        white-space: normal;
        text-align: left;
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
        border: 1px solid #006edc;
        background-color: white;
        color: #006edc;
        transition: all 0.3s ease;
      }

      .bot-message .faq-btn:hover {
        background-color: #006edc;
        color: white;
      }

      /* .bot-message .faq-btn:last-child {
        margin-top: 0.5rem;
        background-color: #28a745;
        border-color: #28a745;
        color: white;
      }

      .bot-message .faq-btn:last-child:hover {
        background-color: #218838;
        border-color: #218838;
      } */

      .user-message {
        background-color: #006edc;
        color: white;
        border-radius: 15px 15px 0 15px;
        margin-left: auto;
      }

      .message-input {
        position: sticky;
        bottom: 0;
        background-color: white;
        padding: 1rem 2rem;
        border-top: 1px solid #dee2e6;
        z-index: 1000;
      }

      /* Add these new styles */
      .message-animation {
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .typing-bubble {
        padding: 0.5rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.3rem;
      }

      .dot {
        width: 8px;
        height: 8px;
        background: #006edc;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out;
      }

      .dot:nth-child(1) {
        animation-delay: -0.32s;
      }
      .dot:nth-child(2) {
        animation-delay: -0.16s;
      }

      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }

      .bot-message .faq-btn {
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
      }

      .bot-message .faq-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .bot-message .faq-btn:active {
        transform: translateY(0);
      }

      .agent-btn {
        background-color: #28a745 !important;
        border-color: #28a745 !important;
        color: white !important;
      }

      .agent-btn:hover {
        background-color: #218838 !important;
        border-color: #218838 !important;
      }

      #messageInput:focus {
        box-shadow: 0 0 0 0.2rem rgba(0, 110, 220, 0.25);
        border-color: #006edc;
      }

      .messages-wrapper {
        flex: 1;
        padding: 1rem;
        overflow-y: auto;
      }

      .typing-indicator {
        position: relative;
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <!-- sidebar boostrap 5-->

    <div class="container-fluid overflow-hidden">
      <div class="row vh-100 overflow-auto">
        <div
          class="col-12 col-sm-3 col-xl-2 px-sm-2 px-0 bg-white d-flex sticky-top"
        >
          <div
            class="d-flex flex-sm-column flex-row flex-grow-1 align-items-center align-items-sm-start px-3 pt-2 text-dark pb-2"
            id="sidebar"
          >
            <a
              href="/"
              class="d-flex align-items-center pb-sm-3 mb-md-0 me-md-auto text-dark text-decoration-none"
            >
              <span class="fs-5 mt-2"
                ><img
                  src="/static/images/spes-logo.png"
                  alt=""
                  srcset=""
                  class="spes-logo-img"
                /><span class="d-none d-sm-inline" id="logo-name"
                  >SPES</span
                ></span
              >
            </a>
            <ul
              class="nav nav-pills flex-sm-column flex-row flex-nowrap flex-shrink-1 flex-sm-grow-0 flex-grow-1 mb-sm-auto mb-0 justify-content-center align-items-center align-items-sm-start"
              id="menu"
            >
              <li>
                <a
                  href="{{ url_for('new_applicants_dashboard') }}"
                  class="nav-link px-sm-0 px-2"
                >
                  <i class="fs-5 bi-speedometer2"></i
                  ><span class="ms-3 d-none d-sm-inline">Dashboard</span>
                </a>
              </li>
              <li>
                <a
                  href="{{ url_for('new_applicants_forms') }}"
                  class="nav-link px-sm-0 px-2"
                >
                  <i class="fs-5 bi-file-earmark-text"></i
                  ><span class="ms-3 d-none d-sm-inline">Forms</span>
                </a>
              </li>
              <li>
                <a
                  href="{{ url_for('new_applicants_notifications') }}"
                  class="nav-link px-sm-0 px-2"
                >
                  <i class="fs-5 bi-bell"></i
                  ><span class="ms-3 d-none d-sm-inline">Notifications</span>
                </a>
              </li>
              <li>
                <a href="#" class="nav-link px-sm-0 px-2">
                  <i class="fs-5 bi-envelope"></i
                  ><span class="ms-3 d-none d-sm-inline" id="sidebar-active"
                    >Messages</span
                  >
                </a>
              </li>
              <li class="dropdown d-sm-none">
                <a
                  href="#"
                  class="nav-link dropdown-toggle px-sm-0 px-1"
                  id="dropdown"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  <i class="fs-5 bi-list"></i
                  ><span class="ms-3 d-none d-sm-inline"></span>
                </a>
                <ul
                  class="dropdown-menu dropdown-menu-dark text-small shadow"
                  aria-labelledby="dropdown"
                >
                  <li><a class="dropdown-item" href="#">Dashboard</a></li>
                  <li><a class="dropdown-item" href="#">Messages</a></li>
                  <li><a class="dropdown-item" href="#">Profile</a></li>
                  <li>
                    <hr class="dropdown-divider" />
                  </li>
                  <li>
                    <a class="dropdown-item" href="{{ url_for('logout') }}"
                      >Sign out</a
                    >
                  </li>
                </ul>
              </li>
            </ul>
            <div
              class="dropdown py-sm-4 mt-sm-auto ms-auto ms-sm-0 flex-shrink-1"
            >
              <a
                href="#"
                class="d-flex align-items-center text-dark text-decoration-none dropdown-toggle"
                id="dropdownUser1"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <i class="bi bi-person-circle fs-4"></i>
                <span class="d-none d-sm-inline mx-1">{{ username }}</span>
              </a>
              <ul
                class="dropdown-menu dropdown-menu-dark text-small shadow"
                aria-labelledby="dropdownUser1"
              >
                <li><a class="dropdown-item" href="#">Settings</a></li>
                <li><a class="dropdown-item" href="#">Profile</a></li>
                <li>
                  <hr class="dropdown-divider" />
                </li>
                <li>
                  <a class="dropdown-item" href="{{ url_for('logout') }}"
                    >Sign out</a
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="col d-flex flex-column h-sm-100">
          <main class="row overflow-auto">
            <div class="col pt-4">
              <h3>Messages</h3>

              <hr />
              <div class="main-container">
                <div class="chat-container">
                  <!-- Messages container -->
                  <div
                    class="messages-wrapper"
                    style="height: calc(100vh - 200px); overflow-y: auto"
                  >
                    <!-- Bot's initial message -->
                    <div class="d-flex mb-3 message-animation">
                      <div class="bot-avatar me-2">
                        <img
                          src="/static/images/spes-logo.png"
                          alt="Bot"
                          class="rounded-circle"
                          style="width: 40px; height: 40px"
                        />
                      </div>
                      <div
                        class="bot-message p-3 rounded"
                        style="max-width: 80%"
                      >
                        <p class="mb-2">Hi, how may I help you?</p>
                        
                          <!-- Remove the Chat with a real agent button and its handler -->
                        </div>
                      </div>
                    </div>

                    <!-- Messages will be added here -->
                    <div id="messagesContainer"></div>

                    <!-- Typing indicator (hidden by default) -->
                    <div class="typing-indicator d-none">
                      <div class="d-flex mb-3">
                        <div class="bot-avatar me-2">
                          <img
                            src="/static/images/spes-logo.png"
                            alt="Bot"
                            class="rounded-circle"
                            style="width: 40px; height: 40px"
                          />
                        </div>
                        <div
                          class="bot-message bg-light p-3 rounded typing-bubble"
                        >
                          <span class="dot"></span>
                          <span class="dot"></span>
                          <span class="dot"></span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Message input area -->
                  <div class="message-input">
                    <div class="input-group">
                      <input
                        type="text"
                        class="form-control"
                        placeholder="Type your message here..."
                        id="messageInput"
                        onkeypress="handleKeyPress(event)"
                      />
                      <button class="btn btn-primary" onclick="sendMessage()">
                        <i class="bi bi-send"></i> Send
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
              <script>
                // Function to scroll chat to bottom with a small delay to ensure DOM updates
                function scrollToBottom() {
                  setTimeout(() => {
                    const mainElement = document.querySelector("main");
                    mainElement.scrollTop = mainElement.scrollHeight;
                  }, 100);
                }

                // Function to show typing indicator
                function showTypingIndicator() {
                  const typingIndicator =
                    document.querySelector(".typing-indicator");
                  typingIndicator.classList.remove("d-none");
                  scrollToBottom();
                }

                // Function to hide typing indicator
                function hideTypingIndicator() {
                  const typingIndicator =
                    document.querySelector(".typing-indicator");
                  typingIndicator.classList.add("d-none");
                }

                // Function to add a message to the chat
                function addMessage(content, isUser = false) {
                  const messagesContainer =
                    document.getElementById("messagesContainer");
                  const messageDiv = document.createElement("div");
                  messageDiv.className = "d-flex mb-3 message-animation";

                  if (isUser) {
                    messageDiv.innerHTML = `
                      <div class="user-message bg-primary text-white p-3 rounded ms-auto" style="max-width: 80%;">
                        <p class="mb-0">${content}</p>
                      </div>
                    `;
                  } else {
                    messageDiv.innerHTML = `
                      <div class="bot-avatar me-2">
                        <img src="/static/images/spes-logo.png" alt="Bot" class="rounded-circle" style="width: 40px; height: 40px;">
                      </div>
                      <div class="bot-message p-3 rounded" style="max-width: 80%;">
                        <p class="mb-0">${content}</p>
                      </div>
                    `;
                  }

                  messagesContainer.appendChild(messageDiv);
                  // Force a reflow to ensure the new message is rendered
                  messageDiv.offsetHeight;
                  scrollToBottom();
                }

                function handleFAQClick(button) {
                  const question = button.textContent
                    .replace(/\s+/g, " ")
                    .trim();
                  addMessage(question, true);
                  showTypingIndicator();

                  // FAQ responses
                  const faqResponses = {
                    "Ilan po ang kailangang isubmit na set ng documents?":
                      "Apat (4) na sets ng documents. Bawat set ay kailangang naka-staple nang magkakahiwalay.",
                    "Ano po ang laman ng bawat set?":
                      "✔ Set 1 – SPES Forms + Original at Certified True Copy ng ibang requirements<br/>✔ Set 2 – SPES Forms + Photocopy ng ibang requirements<br/>✔ Set 3 – SPES Forms + Photocopy ng ibang requirements<br/>✔ Set 4 – SPES Forms + Photocopy ng ibang requirements",
                    "Saan po ilalagay ang mga sets?":
                      "Ilagay ang lahat ng sets sa isang Long Folder at Long Plastic Envelope.",
                    "Kailangan po ba ng ID photo? Ilan po?":
                      "Oo, kailangan ng isang (1) extra Passport Size ID photo na may blue background.<br/>✍ Sa likod ng ID photo, isulat ang iyong pangalan gamit ang format: LAST NAME, FIRST NAME, MIDDLE INITIAL.",
                    "Ano po ang minimum grade requirement para makapag-apply?":
                      "Wala dapat subject na mas mababa sa 80 o 2.75.",
                    "Kailangan po ba na computerized ang SPES Forms?":
                      "Oo, lahat ng ipi-fill out sa SPES forms ay dapat computerized, maliban sa signature na kailangang pirmahan gamit ang ballpen. Bawal ang e-signature.",
                    "Ano po ang dapat isulat sa upper right corner ng Application Form?":
                      "Ilagay ang pangalan ng iyong magulang o guardian na GSIS beneficiary para sa GSIS Insurance.",
                    "Kailangan po bang isulat ang special skills sa form?":
                      "Oo, dapat mong isulat ang iyong mga espesyal na kasanayan sa application form.",
                    "Kailan po ipapasa ang mga requirements?":
                      "Itabi muna ang mga requirements. Ipasa lamang ang mga ito kung nakapasa ka na sa exam.",
                    "Kailan po ang deadline ng final submission ng requirements?":
                      "Ang petsa ng submission ng final requirements ay malalaman isang (1) linggo matapos ang exam.",
                    "Kailan po ang deadline ng pagsusumite ng physical copies ng requirements?":
                      "Ang deadline ay sa mismong araw ng interview, na malalaman isang (1) linggo matapos ang exam.",
                    "Saan po ipapasa ang mga physical copies ng requirements?":
                      "Ipapasa ang mga ito sa PESO Office – Paete Municipal, na matatagpuan sa may stage.",
                    "May second chance po ba o retake kung magkaproblema sa exam?":
                      "❌ Wala pong retake sa SPES exam.<br/>📌 Kaya siguraduhing maayos ang inyong device at internet connection, at basahin nang mabuti ang mga instructions at warnings bago magsimula.",
                    "Kailan po malalaman ang schedule ng exam?":
                      "🕒 Malalaman ang schedule ng exam sa loob ng isang (1) linggo matapos makapagsumite ng initial documents.",
                    "Kailan po lalabas ang resulta ng exam?":
                      "📝 Lalabas ang resulta ng exam isang (1) linggo pagkatapos ito ay maisagawa.",
                    "Kailan po ang schedule ng interview at pagsusumite ng physical copies ng requirements?":
                      "📋 Malalaman ang iskedyul ng interview at pagpapasa ng physical copies ng requirements isang (1) linggo matapos ang exam.",
                  };

                  setTimeout(() => {
                    hideTypingIndicator();
                    const response = faqResponses[question];
                    if (response) {
                      addMessage(response);
                    } else {
                      console.log("Question not found:", question); // Debug log
                      addMessage(
                        "I apologize, but I don't have an answer for that question yet."
                      );
                    }
                  }, 1500);
                }

                function resetChatState() {
                  // chatRoom = null; // Removed as per edit hint
                  // chatConnected = false; // Removed as per edit hint
                  // document.getElementById('messageInput').disabled = true; // Removed as per edit hint
                }

                // Remove handleAgentClick function and any references to it
                // function handleAgentClick() {
                //   addMessage('I would like to chat with a real agent', true);
                //   socket.emit('chat_request', { applicant_id: userId, applicant_name: userName });
                //   addMessage('<em>Waiting for an agent to connect...</em>', false);
                //   resetChatState();
                // }

                function handleKeyPress(event) {
                  if (event.key === "Enter") {
                    sendMessage();
                  }
                }

                function sendMessage() {
                  // if (!chatConnected) return; // Removed as per edit hint
                  const input = document.getElementById('messageInput');
                  const message = input.value.trim();
                  if (!message) return;
                  socket.emit('send_message', {
                    sender_id: userId,
                    receiver_id: adminId,
                    content: message,
                    room: chatRoom
                  });
                  input.value = '';
                }

                // Add this new function after the existing JavaScript functions
                function handleCategoryClick(category) {
                  const categoryName = document
                    .querySelector(
                      `[onclick="handleCategoryClick('${category}')"]`
                    )
                    .textContent.trim();
                  addMessage(categoryName, true);
                  showTypingIndicator();

                  const categoryFAQs = {
                    documents: [
                      "Ilan po ang kailangang isubmit na set ng documents?",
                      "Ano po ang laman ng bawat set?",
                      "Saan po ilalagay ang mga sets?",
                      "Kailangan po ba ng ID photo? Ilan po?",
                    ],
                    forms: [
                      "Ano po ang minimum grade requirement para makapag-apply?",
                      "Kailangan po ba na computerized ang SPES Forms?",
                      "Ano po ang dapat isulat sa upper right corner ng Application Form?",
                      "Kailangan po bang isulat ang special skills sa form?",
                    ],
                    deadlines: [
                      "Kailan po ipapasa ang mga requirements?",
                      "Kailan po ang deadline ng final submission ng requirements?",
                      "Kailan po ang deadline ng pagsusumite ng physical copies ng requirements?",
                      "Saan po ipapasa ang mga physical copies ng requirements?",
                    ],
                    exam: [
                      "May second chance po ba o retake kung magkaproblema sa exam?",
                      "Kailan po malalaman ang schedule ng exam?",
                      "Kailan po lalabas ang resulta ng exam?",
                    ],
                    interview: [
                      "Kailan po ang schedule ng interview at pagsusumite ng physical copies ng requirements?",
                    ],
                  };

                  setTimeout(() => {
                    hideTypingIndicator();
                    const faqs = categoryFAQs[category];
                    let response = `<div class="faq-options">`;
                    faqs.forEach((faq) => {
                      response += `<button class="btn btn-sm btn-outline-primary m-1 faq-btn" onclick="handleFAQClick(this)">${faq}</button>`;
                    });
                    // Remove the Chat with a real agent
                    response += `</div>`;
                    addMessage(response);
                  }, 1500);
                }

                // Initial scroll to bottom when page loads
                window.addEventListener("load", () => {
                  setTimeout(scrollToBottom, 500); // small delay
                });

                // Add scroll event listener to handle manual scrolling
                const mainElement = document.querySelector("main");
                mainElement.addEventListener("scroll", () => {
                  // scroll handling logic
                  //
                });

                // --- Real-time Messaging Integration ---
                const socket = io();
                const userId = {{ session['user_id']|tojson }};
                const adminId = 4; //admin user_id, static for now
                const chatRoom = `chat_${userId}_${adminId}`;
                socket.emit('join', { room: chatRoom });
                let chatConnected = false;

                function fetchMessages() {
                  fetch(`/user/messages/history/${adminId}`)
                    .then(res => res.json())
                    .then(data => {
                      if (data.success) {
                        renderMessages(data.messages);
                      }
                    });
                }

                function renderMessages(messages) {
                  const messagesContainer = document.getElementById('messagesContainer');
                  messagesContainer.innerHTML = '';
                  if (!messages.length) {
                    messagesContainer.innerHTML = '<div class="text-center text-muted mt-5">No messages yet.</div>';
                    return;
                  }
                  messages.forEach(msg => {
                    if (msg.sender_id === userId) {
                      messagesContainer.innerHTML += `<div class='d-flex mb-3'><div class='user-message bg-primary text-white p-3 rounded ms-auto' style='max-width: 80%;'><p class='mb-0'>${msg.content}</p></div></div>`;
                    } else {
                      messagesContainer.innerHTML += `<div class='d-flex mb-3'><div class='bot-avatar me-2'><img src='/static/images/spes-logo.png' alt='Admin' class='rounded-circle' style='width: 40px; height: 40px;'></div><div class='bot-message p-3 rounded' style='max-width: 80%;'><p class='mb-0'>${msg.content}</p></div></div>`;
                    }
                  });
                  scrollToBottom();
                }

                socket.on('chat_accept', data => {
                  chatConnected = true;
                  // document.getElementById('messageInput').disabled = false; // Removed as per edit hint
                });

                function appendSystemMessage(text) {
                  const messagesContainer = document.getElementById('messagesContainer');
                  messagesContainer.innerHTML += `<div class='d-flex mb-3'><div class='w-100 text-center text-secondary small'><em>${text}</em></div></div>`;
                  scrollToBottom();
                }

                socket.on('receive_message', function(data) {
                  if ((chatRoom && data.room === chatRoom) ||
                      (data.sender_id === adminId && data.receiver_id === userId) ||
                      (data.sender_id === userId && data.receiver_id === adminId)) {
                    appendMessage(data);
                  }
                });

                function appendMessage(msg) {
                  const messagesContainer = document.getElementById('messagesContainer');
                  if (msg.sender_id === userId) {
                    // User message: right side
                    messagesContainer.innerHTML += `<div class='d-flex mb-3'><div class='user-message bg-primary text-white p-3 rounded ms-auto' style='max-width: 80%;'><p class='mb-0'>${msg.content}</p></div></div>`;
                  } else {
                    // Admin message: left side
                    messagesContainer.innerHTML += `<div class='d-flex mb-3'><div class='bot-avatar me-2'><img src='/static/images/spes-logo.png' alt='Admin' class='rounded-circle' style='width: 40px; height: 40px;'></div><div class='bot-message p-3 rounded' style='max-width: 80%;'><p class='mb-0'>${msg.content}</p></div></div>`;
                  }
                  scrollToBottom();
                }

                socket.on('chat_closed', data => {
                  if (chatRoom && data.room === chatRoom) {
                    appendSystemMessage(data.reason);
                    // document.getElementById('messageInput').disabled = true; // Removed as per edit hint
                    chatConnected = false;
                    // Do not set chatRoom = null; since it's a const
                  }
                });

                window.addEventListener('load', () => {
                  fetchMessages();
                  resetChatState();
                });
              </script>
            </div>
          </main>
          <!-- <footer class="row bg-light py-4 mt-auto">
            <div class="col">&copy SPES 2025 | All rights reserved.</div>
          </footer> -->
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
