<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/static/images/spes-logo.png" type="image/png" />
    <title>DigiSPES</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css"
    />
    <style>
      /* this is needed to make the content scrollable on larger screens */
      @media (min-width: 576px) {
        .h-sm-100 {
          height: 100%;
        }
      }

      .spes-logo-img {
        width: 50px;
      }
      #logo-name {
        margin-left: 0.5rem;
        font-size: 1.5rem;
        font-weight: bold;
      }
      #sidebar {
        box-shadow: 2px 4px 6px rgba(0, 0, 0, 0.1);
      }
      #card-body {
        background-color: #006edc;
        border-radius: 0.5rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .card-link {
        text-decoration: none;
        padding: 0.7rem 1rem;
        border-radius: 0.5rem;
        border: 1px solid white;
        background-color: white;

        &:hover {
          background-color: #006edc;
          color: white;
          border: 1px solid white;
        }
      }
      .main-container {
        background-color: rgb(236 237 239);
        padding: 1rem;
        border-radius: 0.25rem;
      }
      #sidebar-active {
        background-color: #006edc;
        color: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: background-color 0.3s ease, color 0.3s ease;
        padding: 0.5rem 1rem;
      }
      .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 1.5rem;
      }
      /* on mobile */
      @media (max-width: 576px) {
        .grid2 {
          grid-template-columns: 1fr;
        }
        .cfa-img {
          width: 95% !important;
          height: 130px !important;
          border-radius: 0.5rem;
        }
        #cfa-text {
          font-size: 1rem !important;
        }
      }
      /* tablet */
      @media (min-width: 576px) and (max-width: 768px) {
        .grid2 {
          grid-template-columns: 1fr 1fr;
        }
        .cfa-img {
          width: 95% !important;
          height: 130px !important;
          border-radius: 0.5rem;
        }
        #cfa-text {
          font-size: 1.2rem !important;
        }
      }
      .cfa-img {
        width: 90%;
        height: 200px;
        border-radius: 0.5rem;
      }
      #cfa-text {
        font-size: 1.9rem;
      }
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
      }
      .custom-toast {
        background-color: white;
        border-left: 4px solid #006edc;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }
      .custom-toast .toast-header {
        background-color: #f8f9fa;
        color: #006edc;
      }
      .custom-toast .toast-header i {
        margin-right: 8px;
      }
      .custom-toast.success {
        border-left-color: #198754;
      }
      .custom-toast.success .toast-header {
        color: #198754;
      }
      .custom-toast.error {
        border-left-color: #dc3545;
      }
      .custom-toast.error .toast-header {
        color: #dc3545;
      }
      .custom-toast.warning {
        border-left-color: #ffc107;
      }
      .custom-toast.warning .toast-header {
        color: #ffc107;
      }

 
              /* ITO AY YUN SA CHATBOT  */

              
      /* ================================
   üîπ FAQ Floating Button
   ================================ */
/* Floating Button */
.faq-logo {
  position: fixed;
  bottom: 32px;
  right: 32px;
  display: flex;
  align-items: center;
  gap: 10px;
  background: linear-gradient(90deg, #006edc 0%, #007bff 100%);
  color: #fff;
  padding: 12px 22px;
  border-radius: 32px;
  box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
  font-family: 'Segoe UI', Arial, sans-serif;
  font-size: 1rem;
  font-weight: 500;
  border: none;
  cursor: pointer;
  transition: background 0.3s, transform 0.2s;
  z-index: 1051;
}

.faq-logo {
  max-width: 300px;
  width: auto;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}


.faq-logo:hover,
.faq-logo:focus {
  background: linear-gradient(90deg, #005bb5 0%, #006edc 100%);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.22);
  transform: translateY(-2px);
  text-decoration: none;
  color: #fff;
}

.faq-logo-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.4rem;
  background: rgba(255, 255, 255, 0.15);
  border-radius: 50%;
  width: 32px;
  height: 32px;
}

/* Chat Message Container */
#faqChatMessages {
  display: flex;
  flex-direction: column;
  gap: 10px;
  font-size: 0.92rem;
  line-height: 1.5;
  word-break: break-word;
  overflow-wrap: break-word;
  padding-right: 5px;
  max-height: 220px;
  overflow-y: auto;
  overflow-x: hidden;
}

/* User Message */
.faq-user-message {
  align-self: flex-end;
  background-color: #007bff;
  color: #fff;
  padding: 10px 16px;
  border-radius: 18px 18px 4px 18px;
  max-width: 85%;
  box-shadow: 0 2px 8px rgba(0, 123, 255, 0.25);
  font-family: 'Segoe UI', Arial, sans-serif;
  white-space: pre-wrap;
}

/* Bot Message */
.faq-bot-message {
  align-self: flex-start;
  background-color: #ffffff;
  color: #222;
  padding: 10px 16px;
  border-radius: 18px 18px 18px 4px;
  max-width: 85%;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  position: relative;
  font-family: 'Segoe UI', Arial, sans-serif;
  white-space: pre-wrap;
}

/* Bot Icon (optional) */
.faq-bot-message::before {
  content: "";
  position: absolute;
  left: -24px;
  top: 4px;
  font-size: 1rem;
}

 /*TAPOS NG SA CHATBOT  */


    </style>
  </head>
  <body>
    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- sidebar boostrap 5-->

    <div class="container-fluid overflow-hidden">
      <div class="row vh-100 overflow-auto">
        <div
          class="col-12 col-sm-3 col-xl-2 px-sm-2 px-0 bg-white d-flex sticky-top"
        >
          <div
            class="d-flex flex-sm-column flex-row flex-grow-1 align-items-center align-items-sm-start px-3 pt-2 text-dark pb-2"
            id="sidebar"
          >
            <a
              href="/"
              class="d-flex align-items-center pb-sm-3 mb-md-0 me-md-auto text-dark text-decoration-none"
            >
              <span class="fs-5 mt-2"
                ><img
                  src="/static/images/spes-logo.png"
                  alt=""
                  srcset=""
                  class="spes-logo-img"
                /><span class="d-none d-sm-inline" id="logo-name"
                  >SPES</span
                ></span
              >
            </a>
            <ul
              class="nav nav-pills flex-sm-column flex-row flex-nowrap flex-shrink-1 flex-sm-grow-0 flex-grow-1 mb-sm-auto mb-0 justify-content-center align-items-center align-items-sm-start"
              id="menu"
            >
              <li>
                <a
                  href="#"
                  data-bs-toggle="collapse"
                  class="nav-link px-sm-0 px-2"
                >
                  <i class="fs-5 bi-speedometer2"></i
                  ><span class="ms-3 d-none d-sm-inline" id="sidebar-active"
                    >Dashboard</span
                  >
                </a>
              </li>
              <li>
                <a
                  href="{{ url_for('old_applicants_forms') }}"
                  class="nav-link px-sm-0 px-2"
                >
                  <i class="fs-5 bi-file-earmark-text"></i
                  ><span class="ms-3 d-none d-sm-inline">Forms</span>
                </a>
              </li>
              <li>
                <a
                  href="{{ url_for('old_applicants_notifications') }}"
                  class="nav-link px-sm-0 px-2"
                >
                  <i class="fs-5 bi-bell"></i
                  ><span class="ms-3 d-none d-sm-inline">Notifications</span>
                </a>
              </li>
              <li>
                <a
                  href="{{ url_for('old_applicants_messages') }}"
                  class="nav-link px-sm-0 px-2"
                >
                  <i class="fs-5 bi-envelope"></i
                  ><span class="ms-3 d-none d-sm-inline">Messages</span>
                </a>
              </li>

              <li class="dropdown d-sm-none">
                <a
                  href="#"
                  class="nav-link dropdown-toggle px-sm-0 px-1"
                  id="dropdown"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  <i class="fs-5 bi-list"></i
                  ><span class="ms-3 d-none d-sm-inline"></span>
                </a>
                <ul
                  class="dropdown-menu dropdown-menu-dark text-small shadow"
                  aria-labelledby="dropdown"
                >
                  <li><a class="dropdown-item" href="#">Dashboard</a></li>
                  <li><a class="dropdown-item" href="#">Messages</a></li>
                  <li><a class="dropdown-item" href="#">Profile</a></li>
                  <li>
                    <hr class="dropdown-divider" />
                  </li>
                  <li><a class="dropdown-item" href="#">Sign out</a></li>
                </ul>
              </li>
            </ul>
            <div
              class="dropdown py-sm-4 mt-sm-auto ms-auto ms-sm-0 flex-shrink-1"
            >
              <a
                href="#"
                class="d-flex align-items-center text-dark text-decoration-none dropdown-toggle"
                id="dropdownUser1"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <i class="bi bi-person-circle fs-4"></i>
                <span class="d-none d-sm-inline mx-1">{{ username }}</span>
              </a>
              <ul
                class="dropdown-menu dropdown-menu-dark text-small shadow"
                aria-labelledby="dropdownUser1"
              >
                <li><a class="dropdown-item" href="#">Settings</a></li>
                <li><a class="dropdown-item" href="#">Profile</a></li>
                <li>
                  <hr class="dropdown-divider" />
                </li>
                <li>
                  <a class="dropdown-item" href="{{ url_for('logout') }}"
                    >Sign out</a
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="col d-flex flex-column h-sm-100">
          <main class="row overflow-auto">
            <div class="col pt-4">
              <h3>Dashboard</h3>

              <hr />
              <div class="main-container">
                <h3>Welcome, {{ username }}!</h3>
                <!-- bootstrap card -->
                <div class="card mb-3">
                  <div class="card-body" id="card-body">
                    <h5 class="card-title text-white">Announcement</h5>
                    <div class="grid2">
                      <div class="cfa-img-container">
                        <img
                          src="/static/images/call-for-application.png"
                          alt="cfa image"
                          class="cfa-img"
                        />
                      </div>
                      <div>
                        <p class="card-text text-white" id="cfa-text">
                          {% if latest_announcement %}
                          <!-- {{
                          latest_announcement.title }}
                          <br /> -->
                          <small>{{ latest_announcement.description }}</small>
                          {% else %} Special Program for Employment of Students
                          (SPES) 2025
                          <strong>is now open!</strong>
                          {% endif %}
                        </p>
                        <br />
                        <div class="d-flex align-items-center gap-3">
                          <!-- <span class="text-white">
                            <strong>Document Upload Available</strong>
                          </span> -->
                          <a
                            href="{{ url_for('old_applicants_forms') }}"
                            class="card-link"
                          >
                            Upload Documents
                          </a>
                        </div>
                      </div>
                    </div>
                    <br />
                    .
                  </div>
                </div>
              </div>
            </div>
            

 <!-- ITO AY YUN SA CHATBOT  -->
              
           <!-- FAQ Floating Button -->
<button class="faq-logo shadow-lg" type="button" id="faqBtn" aria-label="Open FAQs">
  <span class="faq-logo-icon">
    <i class="bi bi-question-circle-fill"></i>
  </span>
  <span class="d-inline d-md-none">FAQs</span>
</button>

<!-- FAQ Chat Modal -->
<div class="modal fade" id="faqChatModal" tabindex="-1" aria-labelledby="faqChatModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-bottom-end modal-sm" style="position: fixed; bottom: 90px; right: 32px; margin: 0; z-index: 1060;">
    <div class="modal-content shadow-lg border-0 rounded-4">
      <div class="modal-header bg-primary text-white py-2 rounded-top-4">
        <h6 class="modal-title d-flex align-items-center gap-2" id="faqChatModalLabel">
          <i class="bi bi-chat-dots"></i> Ask a Question
        </h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-3" style="background: #f8fafd;">
        <!-- Chat Messages Container -->
        <div id="faqChatMessages" class="mb-3 text-secondary">
          <div class="faq-bot-message">üëã Hi! Ask anything about <strong>SPES</strong> or this portal.</div>
        </div>

        <!-- Input box -->
        <form id="faqChatForm" autocomplete="off">
          <div class="input-group">
            <input type="text" class="form-control rounded-start-3 border-end-0" id="faqChatInput" placeholder="Type your question..." required />
            <button class="btn btn-primary rounded-end-3" type="submit" aria-label="Send">
              <i class="bi bi-send"></i>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Show modal on button click
  document.getElementById('faqBtn').addEventListener('click', function () {
    const faqModal = new bootstrap.Modal(document.getElementById('faqChatModal'));
    faqModal.show();
    setTimeout(() => document.getElementById('faqChatInput').focus(), 400);
  });

  // Handle chat form submission
  document.getElementById('faqChatForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const input = document.getElementById('faqChatInput');
    const msg = input.value.trim();
    if (!msg) return;

    const messages = document.getElementById('faqChatMessages');
    messages.innerHTML += `<div class="faq-user-message">${msg}</div>`;
    input.value = '';
    messages.scrollTop = messages.scrollHeight;

    // Send message to Python backend
    fetch('/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: msg })
    })
    .then(res => res.json())
    .then(data => {
      messages.innerHTML += `<div class="faq-bot-message">${data.response}</div>`;
      messages.scrollTop = messages.scrollHeight;
    })
    .catch(error => {
      messages.innerHTML += `<div class="faq-bot-message bg-danger text-white">‚ùå Error: ${error}</div>`;
      messages.scrollTop = messages.scrollHeight;
    });
  });

  // Reset input on modal close
  document.getElementById('faqChatModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('faqChatInput').value = '';
  });
</script>

<!-- TAPOS NG SA CHATBOT  -->

          </main>
          <footer class="row bg-light py-4 mt-auto">
            <div class="col">&copy SPES 2025 | All rights reserved.</div>
          </footer>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function validateFileType(input, documentType) {
        const file = input.files[0];
        const feedback = input.nextElementSibling;

        // Reset state
        input.classList.remove("is-invalid", "is-valid");
        feedback.style.display = "none";
        feedback.classList.remove("text-danger", "text-success");

        if (!file) {
          return;
        }

        // Check if file is PDF or image
        if (file.type !== "application/pdf" && !file.type.startsWith("image/")) {
          input.value = "";
          input.classList.add("is-invalid");
          feedback.classList.add("text-danger");
          feedback.querySelector("i").className = "bi bi-x-circle-fill me-2";
          feedback.querySelector("span").textContent = "Please upload a valid image or PDF file.";
          feedback.style.display = "flex";
          return;
        }

        // For images, validate content using OCR
        if (file.type.startsWith("image/")) {
          feedback.classList.add("text-primary");
          feedback.querySelector("i").className = "bi bi-hourglass-split me-2";
          feedback.querySelector("span").textContent = "Processing image...";
          feedback.style.display = "flex";

          const reader = new FileReader();
          reader.onload = function(e) {
            feedback.querySelector("span").textContent = "Loading image...";

            const img = new Image();
            img.onload = function() {
              feedback.querySelector("span").textContent = "Preparing image for OCR...";

              // Create canvas to process image
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');

              // Calculate new dimensions while maintaining aspect ratio
              let width = img.width;
              let height = img.height;
              const MAX_SIZE = 1024; // Maximum dimension

              if (width > height && width > MAX_SIZE) {
                height = Math.round((height * MAX_SIZE) / width);
                width = MAX_SIZE;
              } else if (height > MAX_SIZE) {
                width = Math.round((width * MAX_SIZE) / height);
                height = MAX_SIZE;
              }

              canvas.width = width;
              canvas.height = height;
              ctx.drawImage(img, 0, 0, width, height);

              feedback.querySelector("span").textContent = "Performing OCR analysis...";

              // Convert canvas to base64
              const base64Image = canvas.toDataURL('image/jpeg', 0.8);

              // Send to backend for OCR validation
              fetch('/validate-document-content', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  imageData: base64Image,
                  documentType: documentType
                })
              })
              .then(response => response.json())
              .then(data => {
                if (data.valid) {
                  input.classList.add("is-valid");
                  feedback.classList.remove("text-danger", "text-primary");
                  feedback.classList.add("text-success");
                  feedback.querySelector("i").className = "bi bi-check-circle-fill me-2";
                  feedback.querySelector("span").textContent = "Document validated successfully";
                  showToast(data.message || "Document content validated successfully", "success");
                } else {
                  input.value = "";
                  input.classList.add("is-invalid");
                  feedback.classList.remove("text-success", "text-primary");
                  feedback.classList.add("text-danger");
                  feedback.querySelector("i").className = "bi bi-x-circle-fill me-2";
                  feedback.querySelector("span").textContent = data.message || `Invalid document content. Please upload a valid ${documentType.toUpperCase()} document.`;
                  showToast(data.message || "Invalid document content", "error");
                }
              })
              .catch(error => {
                console.error('Error:', error);
                input.value = "";
                input.classList.add("is-invalid");
                feedback.classList.remove("text-success", "text-primary");
                feedback.classList.add("text-danger");
                feedback.querySelector("i").className = "bi bi-x-circle-fill me-2";
                feedback.querySelector("span").textContent = `Error validating document content: ${error.message}`;
                showToast("Error validating document: " + error.message, "error");
              });
            };
            img.onerror = function() {
              input.value = "";
              input.classList.add("is-invalid");
              feedback.classList.remove("text-success", "text-primary");
              feedback.classList.add("text-danger");
              feedback.querySelector("i").className = "bi bi-x-circle-fill me-2";
              feedback.querySelector("span").textContent = "Error loading image. Please try again.";
              showToast("Error loading image", "error");
            };
            img.src = e.target.result;
          };
          reader.onerror = function() {
            input.value = "";
            input.classList.add("is-invalid");
            feedback.classList.remove("text-success", "text-primary");
            feedback.classList.add("text-danger");
            feedback.querySelector("i").className = "bi bi-x-circle-fill me-2";
            feedback.querySelector("span").textContent = "Error reading file. Please try again.";
            showToast("Error reading file", "error");
          };
          reader.readAsDataURL(file);
        } else {
          // For PDFs, just validate file type
          input.classList.add("is-valid");
          feedback.classList.remove("text-danger", "text-primary");
          feedback.classList.add("text-success");
          feedback.querySelector("i").className = "bi bi-check-circle-fill me-2";
          feedback.querySelector("span").textContent = "Document validated successfully";
          feedback.style.display = "flex";
        }
      }



      // Function to show toast notifications
      function showToast(message, type = 'info') {
        const toastContainer = document.querySelector('.toast-container');
        const toast = document.createElement('div');
        toast.className = `toast custom-toast ${type}`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');

        // Set icon based on type
        let icon = 'bi-info-circle-fill';
        if (type === 'success') icon = 'bi-check-circle-fill';
        if (type === 'error') icon = 'bi-exclamation-circle-fill';
        if (type === 'warning') icon = 'bi-exclamation-triangle-fill';

        toast.innerHTML = `
          <div class="toast-header">
            <i class="bi ${icon}"></i>
            <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body">
            ${message}
          </div>
        `;

        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast, {
          autohide: true,
          delay: 5000
        });
        bsToast.show();

        // Remove toast from DOM after it's hidden
        toast.addEventListener('hidden.bs.toast', () => {
          toast.remove();
        });
      }

      // Check for flash messages from Flask
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            showToast("{{ message }}", "{{ category }}");
          {% endfor %}
        {% endif %}
      {% endwith %}

      // Example usage for other notifications
      document.addEventListener('DOMContentLoaded', function() {
        // Show welcome message
        // showToast("Welcome back, {{ username }}!", "success");

        // Example of how to show other notifications
        // showToast("New message received", "info");
        // showToast("Your exam has been submitted", "success");
        // showToast("Please complete your profile", "warning");
        // showToast("Error loading data", "error");
      });
    </script>
  </body>
</html>
