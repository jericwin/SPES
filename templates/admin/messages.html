<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/static/images/spes-logo.png" type="image/png" />
    <title>DigiSPES</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css"
    />
    <style>
      /* this is needed to make the content scrollable on larger screens */
      @media (min-width: 576px) {
        .h-sm-100 {
          height: 100%;
        }
      }

      .spes-logo-img {
        width: 50px;
      }
      #logo-name {
        margin-left: 0.5rem;
        font-size: 1.5rem;
        font-weight: bold;
      }
      #sidebar {
        box-shadow: 2px 4px 6px rgba(0, 0, 0, 0.1);
      }
      #card-body {
        background-color: #006edc;
        border-radius: 0.5rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .card-link {
        text-decoration: none;
        padding: 0.7rem 1rem;
        border-radius: 0.5rem;
        border: 1px solid white;
        background-color: white;

        &:hover {
          background-color: #006edc;
          color: white;
          border: 1px solid white;
        }
      }
      .main-container {
        background-color: rgb(239, 243, 255);
        padding: 1rem;
        border-radius: 0.25rem;
      }
      #sidebar-active {
        background-color: #006edc;
        color: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: background-color 0.3s ease, color 0.3s ease;
        padding: 0.5rem 1rem;
      }
      .chat-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        background-color: #f8f9fa;
      }

      .bot-message {
        background-color: #f0f2f5;
        border-radius: 15px 15px 15px 0;
      }

      .bot-message .faq-options {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .bot-message .faq-btn {
        white-space: normal;
        text-align: left;
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
        border: 1px solid #006edc;
        background-color: white;
        color: #006edc;
        transition: all 0.3s ease;
      }

      .bot-message .faq-btn:hover {
        background-color: #006edc;
        color: white;
      }

      .bot-message .faq-btn:last-child {
        margin-top: 0.5rem;
        background-color: #28a745;
        border-color: #28a745;
        color: white;
      }

      .bot-message .faq-btn:last-child:hover {
        background-color: #218838;
        border-color: #218838;
      }

      .user-message {
        background-color: #006edc;
        color: white;
        border-radius: 15px 15px 0 15px;
        margin-left: auto;
      }

      .message-input {
        position: sticky;
        bottom: 0;
        background-color: white;
        padding: 1rem 2rem;
        border-top: 1px solid #dee2e6;
        z-index: 1000;
      }

      /* Add these new styles */
      .message-animation {
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .typing-bubble {
        padding: 0.5rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.3rem;
      }

      .dot {
        width: 8px;
        height: 8px;
        background: #006edc;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out;
      }

      .dot:nth-child(1) {
        animation-delay: -0.32s;
      }
      .dot:nth-child(2) {
        animation-delay: -0.16s;
      }

      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }

      .bot-message .faq-btn {
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
      }

      .bot-message .faq-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .bot-message .faq-btn:active {
        transform: translateY(0);
      }

      .agent-btn {
        background-color: #28a745 !important;
        border-color: #28a745 !important;
        color: white !important;
      }

      .agent-btn:hover {
        background-color: #218838 !important;
        border-color: #218838 !important;
      }

      #messageInput:focus {
        box-shadow: 0 0 0 0.2rem rgba(0, 110, 220, 0.25);
        border-color: #006edc;
      }

      .messages-wrapper {
        flex: 1;
        padding: 1rem;
        overflow-y: auto;
      }

      .typing-indicator {
        position: relative;
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <!-- sidebar boostrap 5-->

    <div class="container-fluid overflow-hidden">
      <div class="row vh-100 overflow-auto">
        <div
          class="col-12 col-sm-3 col-xl-2 px-sm-2 px-0 bg-white d-flex sticky-top"
        >
          <div
            class="d-flex flex-sm-column flex-row flex-grow-1 align-items-center align-items-sm-start px-3 pt-2 text-dark pb-2"
            id="sidebar"
          >
            <a
              href="/"
              class="d-flex align-items-center pb-sm-3 mb-md-0 me-md-auto text-dark text-decoration-none"
            >
              <span class="fs-5 mt-2"
                ><img
                  src="/static/images/spes-logo.png"
                  alt=""
                  srcset=""
                  class="spes-logo-img"
                /><span class="d-none d-sm-inline" id="logo-name"
                  >SPES</span
                ></span
              >
            </a>
            <ul
              class="nav nav-pills flex-sm-column flex-row flex-nowrap flex-shrink-1 flex-sm-grow-0 flex-grow-1 mb-sm-auto mb-0 justify-content-center align-items-center align-items-sm-start"
              id="menu"
            >
              <li>
                <a
                  href="{{ url_for('admin_dashboard') }}"
                  class="nav-link px-sm-0 px-2"
                >
                  <i class="fs-5 bi-speedometer2"></i
                  ><span class="ms-3 d-none d-sm-inline">Dashboard</span>
                </a>
              </li>
              <li>
                <a
                  href="{{ url_for('admin_announcements') }}"
                  class="nav-link px-sm-0 px-2"
                >
                  <i class="fs-5 bi-megaphone"></i
                  ><span class="ms-3 d-none d-sm-inline">Announcements</span>
                </a>
              </li>
              <li>
                <a
                  href="{{ url_for('admin_applications') }}"
                  class="nav-link px-sm-0 px-2"
                >
                  <i class="fs-5 bi-file-earmark"></i
                  ><span class="ms-3 d-none d-sm-inline">Applicants</span>
                </a>
              </li>
              <!-- students who took the exam -->
              <li>
                <a
                  href="{{ url_for('admin_examinees') }}"
                  class="nav-link px-sm-0 px-2"
                >
                  <i class="fs-5 bi-people"></i
                  ><span class="ms-3 d-none d-sm-inline">Examinees</span>
                </a>
              </li>
              <li>
                <a
                  href="{{ url_for('admin_exams') }}"
                  class="nav-link px-sm-0 px-2"
                >
                  <i class="fs-5 bi-pencil"></i
                  ><span class="ms-3 d-none d-sm-inline">Exams</span>
                </a>
              </li>
              <li>
                <a href="#" class="nav-link px-sm-0 px-2">
                  <i class="fs-5 bi-people"></i
                  ><span class="ms-3 d-none d-sm-inline">Interview Panel</span>
                </a>
              </li>
              <li>
                <a href="#" class="nav-link px-sm-0 px-2">
                  <i class="fs-5 bi-envelope"></i
                  ><span class="ms-3 d-none d-sm-inline" id="sidebar-active"
                    >Messages</span
                  >
                </a>
              </li>
              <li>
                <a href="#" class="nav-link px-sm-0 px-2">
                  <i class="fs-5 bi-bell"></i
                  ><span class="ms-3 d-none d-sm-inline">Notifications</span>
                </a>
              </li>
              <li class="dropdown d-sm-none">
                <a
                  href="#"
                  class="nav-link dropdown-toggle px-sm-0 px-1"
                  id="dropdown"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  <i class="fs-5 bi-list"></i
                  ><span class="ms-3 d-none d-sm-inline"></span>
                </a>
                <ul
                  class="dropdown-menu dropdown-menu-dark text-small shadow"
                  aria-labelledby="dropdown"
                >
                  <li><a class="dropdown-item" href="#">Dashboard</a></li>
                  <li><a class="dropdown-item" href="#">Messages</a></li>
                  <li><a class="dropdown-item" href="#">Profile</a></li>
                  <li>
                    <hr class="dropdown-divider" />
                  </li>
                  <li>
                    <a class="dropdown-item" href="{{ url_for('logout') }}"
                      >Sign out</a
                    >
                  </li>
                </ul>
              </li>
            </ul>
            <div
              class="dropdown py-sm-4 mt-sm-auto ms-auto ms-sm-0 flex-shrink-1"
            >
              <a
                href="#"
                class="d-flex align-items-center text-dark text-decoration-none dropdown-toggle"
                id="dropdownUser1"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <i class="bi bi-person-circle fs-4"></i>
                <span class="d-none d-sm-inline mx-1">Admin</span>
              </a>
              <ul
                class="dropdown-menu dropdown-menu-dark text-small shadow"
                aria-labelledby="dropdownUser1"
              >
                <li><a class="dropdown-item" href="#">Settings</a></li>
                <li><a class="dropdown-item" href="#">Profile</a></li>
                <li>
                  <hr class="dropdown-divider" />
                </li>
                <li>
                  <a class="dropdown-item" href="{{ url_for('logout') }}"
                    >Sign out</a
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="col d-flex flex-column h-sm-100">
          <main class="row overflow-auto">
            <div class="col pt-4">
              <h3>Messages</h3>

              <hr />
              <div class="main-container row">
                <!-- User List Sidebar -->
                <div
                  class="col-12 col-md-4 col-lg-3 mb-3 mb-md-0"
                  style="height: 75vh; max-height: 75vh"
                >
                  <div class="card h-100 shadow-sm">
                    <div class="card-header bg-primary text-white">
                      <i class="bi bi-people me-2"></i>Users
                    </div>
                    <ul class="list-group list-group-flush" id="userList">
                      <li
                        class="list-group-item user-item active"
                        onclick="selectUser(1)"
                      >
                        <div class="d-flex align-items-center">
                          <img
                            src="https://ui-avatars.com/api/?name=Juan+Dela+Cruz"
                            class="rounded-circle me-2"
                            width="36"
                            height="36"
                            alt="User"
                          />
                          <div>
                            <div class="fw-bold">Waiting for a user</div>
                            <div class="text-muted small">Offline</div>
                          </div>
                        </div>
                      </li>
                      <li
                        class="list-group-item user-item"
                        onclick="selectUser(2)"
                      >
                        <div class="d-flex align-items-center">
                          <img
                            src="https://ui-avatars.com/api/?name=Maria+Santos"
                            class="rounded-circle me-2"
                            width="36"
                            height="36"
                            alt="User"
                          />
                          <div>
                            <div class="fw-bold">Maria Santos</div>
                            <div class="text-muted small">Offline</div>
                          </div>
                        </div>
                      </li>
                      <li
                        class="list-group-item user-item"
                        onclick="selectUser(3)"
                      >
                        <div class="d-flex align-items-center">
                          <img
                            src="https://ui-avatars.com/api/?name=Pedro+Reyes"
                            class="rounded-circle me-2"
                            width="36"
                            height="36"
                            alt="User"
                          />
                          <div>
                            <div class="fw-bold">Pedro Reyes</div>
                            <div class="text-muted small">Online</div>
                          </div>
                        </div>
                      </li>
                    </ul>
                  </div>
                </div>
                <!-- Message Thread Area -->
                <div class="col-12 col-md-8 col-lg-9 d-flex flex-column">
                  <div
                    class="card flex-grow-1 shadow-sm mb-2"
                    style="height: 75vh; max-height: 75vh"
                  >
                    <div class="card-header bg-white d-flex align-items-center">
                      <img
                        src="https://ui-avatars.com/api/?name=Juan+Dela+Cruz"
                        class="rounded-circle me-2"
                        width="40"
                        height="40"
                        alt="User"
                      />
                      <div>
                        <div class="fw-bold" id="chatUserName">
                          Juan Dela Cruz
                        </div>
                        <div class="text-muted small" id="chatUserStatus">
                          Online
                        </div>
                      </div>
                    </div>
                    <div
                      class="card-body messages-wrapper"
                      id="messagesContainer"
                      style="height: 340px; overflow-y: auto"
                    >
                      <!-- Dummy messages -->
                      <div class="d-flex mb-3">
                        <div
                          class="user-message bg-primary text-white p-3 rounded ms-auto"
                          style="max-width: 80%"
                        >
                          <p class="mb-0">
                            Hello, admin! I have a question about my
                            application.
                          </p>
                        </div>
                      </div>
                      <div class="d-flex mb-3">
                        <div class="bot-avatar me-2">
                          <img
                            src="/static/images/spes-logo.png"
                            alt="Admin"
                            class="rounded-circle"
                            style="width: 40px; height: 40px"
                          />
                        </div>
                        <div
                          class="bot-message p-3 rounded"
                          style="max-width: 80%"
                        >
                          <p class="mb-0">Hi Juan! Sure, how can I help you?</p>
                        </div>
                      </div>
                      <div class="d-flex mb-3">
                        <div
                          class="user-message bg-primary text-white p-3 rounded ms-auto"
                          style="max-width: 80%"
                        >
                          <p class="mb-0">
                            What documents do I need to submit?
                          </p>
                        </div>
                      </div>
                      <div class="d-flex mb-3">
                        <div class="bot-avatar me-2">
                          <img
                            src="/static/images/spes-logo.png"
                            alt="Admin"
                            class="rounded-circle"
                            style="width: 40px; height: 40px"
                          />
                        </div>
                        <div
                          class="bot-message p-3 rounded"
                          style="max-width: 80%"
                        >
                          <p class="mb-0">
                            You need to submit 4 sets of documents. Each set
                            must be stapled separately.
                          </p>
                        </div>
                      </div>
                    </div>
                    <!-- Message Input -->
                    <div class="message-input d-flex align-items-center">
                      <input
                        type="text"
                        class="form-control me-2"
                        id="messageInput"
                        placeholder="Type a message..."
                        onkeypress="if(event.key==='Enter'){sendMessage();}"
                      />
                      <button class="btn btn-primary" onclick="sendMessage()">
                        <i class="bi bi-send"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
              <script>
                // Function to scroll chat to bottom with a small delay to ensure DOM updates
                function scrollToBottom() {
                  setTimeout(() => {
                    const messagesContainer = document.getElementById("messagesContainer");
                    if (messagesContainer) {
                      messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                  }, 100);
                }

                // Function to show typing indicator
                function showTypingIndicator() {
                  const typingIndicator =
                    document.querySelector(".typing-indicator");
                  typingIndicator.classList.remove("d-none");
                  scrollToBottom();
                }

                // Function to hide typing indicator
                function hideTypingIndicator() {
                  const typingIndicator =
                    document.querySelector(".typing-indicator");
                  typingIndicator.classList.add("d-none");
                }

                // Function to add a message to the chat
                function addMessage(content, isUser = false) {
                  const messagesContainer =
                    document.getElementById("messagesContainer");
                  const messageDiv = document.createElement("div");
                  messageDiv.className = "d-flex mb-3 message-animation";

                  if (isUser) {
                    messageDiv.innerHTML = `
                      <div class="user-message bg-primary text-white p-3 rounded ms-auto" style="max-width: 80%;">
                        <p class="mb-0">${content}</p>
                      </div>
                    `;
                  } else {
                    messageDiv.innerHTML = `
                      <div class="bot-avatar me-2">
                        <img src="/static/images/spes-logo.png" alt="Bot" class="rounded-circle" style="width: 40px; height: 40px;">
                      </div>
                      <div class="bot-message p-3 rounded" style="max-width: 80%;">
                        <p class="mb-0">${content}</p>
                      </div>
                    `;
                  }

                  messagesContainer.appendChild(messageDiv);
                  // Force a reflow to ensure the new message is rendered
                  messageDiv.offsetHeight;
                  scrollToBottom();
                }

                function handleFAQClick(button) {
                  const question = button.textContent
                    .replace(/\s+/g, " ")
                    .trim();
                  addMessage(question, true);
                  showTypingIndicator();

                  // FAQ responses
                  const faqResponses = {
                    "Ilan po ang kailangang isubmit na set ng documents?":
                      "Apat (4) na sets ng documents. Bawat set ay kailangang naka-staple nang magkakahiwalay.",
                    "Ano po ang laman ng bawat set?":
                      "‚úî Set 1 ‚Äì SPES Forms + Original at Certified True Copy ng ibang requirements<br/>‚úî Set 2 ‚Äì SPES Forms + Photocopy ng ibang requirements<br/>‚úî Set 3 ‚Äì SPES Forms + Photocopy ng ibang requirements<br/>‚úî Set 4 ‚Äì SPES Forms + Photocopy ng ibang requirements",
                    "Saan po ilalagay ang mga sets?":
                      "Ilagay ang lahat ng sets sa isang Long Folder at Long Plastic Envelope.",
                    "Kailangan po ba ng ID photo? Ilan po?":
                      "Oo, kailangan ng isang (1) extra Passport Size ID photo na may blue background.<br/>‚úç Sa likod ng ID photo, isulat ang iyong pangalan gamit ang format: LAST NAME, FIRST NAME, MIDDLE INITIAL.",
                    "Ano po ang minimum grade requirement para makapag-apply?":
                      "Wala dapat subject na mas mababa sa 80 o 2.75.",
                    "Kailangan po ba na computerized ang SPES Forms?":
                      "Oo, lahat ng ipi-fill out sa SPES forms ay dapat computerized, maliban sa signature na kailangang pirmahan gamit ang ballpen. Bawal ang e-signature.",
                    "Ano po ang dapat isulat sa upper right corner ng Application Form?":
                      "Ilagay ang pangalan ng iyong magulang o guardian na GSIS beneficiary para sa GSIS Insurance.",
                    "Kailangan po bang isulat ang special skills sa form?":
                      "Oo, dapat mong isulat ang iyong mga espesyal na kasanayan sa application form.",
                    "Kailan po ipapasa ang mga requirements?":
                      "Itabi muna ang mga requirements. Ipasa lamang ang mga ito kung nakapasa ka na sa exam.",
                    "Kailan po ang deadline ng final submission ng requirements?":
                      "Ang petsa ng submission ng final requirements ay malalaman isang (1) linggo matapos ang exam.",
                    "Kailan po ang deadline ng pagsusumite ng physical copies ng requirements?":
                      "Ang deadline ay sa mismong araw ng interview, na malalaman isang (1) linggo matapos ang exam.",
                    "Saan po ipapasa ang mga physical copies ng requirements?":
                      "Ipapasa ang mga ito sa PESO Office ‚Äì Paete Municipal, na matatagpuan sa may stage.",
                    "May second chance po ba o retake kung magkaproblema sa exam?":
                      "‚ùå Wala pong retake sa SPES exam.<br/>üìå Kaya siguraduhing maayos ang inyong device at internet connection, at basahin nang mabuti ang mga instructions at warnings bago magsimula.",
                    "Kailan po malalaman ang schedule ng exam?":
                      "üïí Malalaman ang schedule ng exam sa loob ng isang (1) linggo matapos makapagsumite ng initial documents.",
                    "Kailan po lalabas ang resulta ng exam?":
                      "üìù Lalabas ang resulta ng exam isang (1) linggo pagkatapos ito ay maisagawa.",
                    "Kailan po ang schedule ng interview at pagsusumite ng physical copies ng requirements?":
                      "üìã Malalaman ang iskedyul ng interview at pagpapasa ng physical copies ng requirements isang (1) linggo matapos ang exam.",
                  };

                  setTimeout(() => {
                    hideTypingIndicator();
                    const response = faqResponses[question];
                    if (response) {
                      addMessage(response);
                    } else {
                      console.log("Question not found:", question); // Debug log
                      addMessage(
                        "I apologize, but I don't have an answer for that question yet."
                      );
                    }
                  }, 1500);
                }

                function handleAgentClick() {
                  addMessage("I would like to chat with a real agent", true);
                  showTypingIndicator();

                  setTimeout(() => {
                    hideTypingIndicator();
                    addMessage(
                      "Connecting to a real agent. Please wait for a moment..."
                    );
                    showTypingIndicator();
                  }, 1500);
                  setTimeout(() => {
                    hideTypingIndicator();
                    addMessage(
                      "Hello! I'm a SPES Agent Jeric. How can I assist you today?"
                    );
                  }, 6500);
                }

                function handleKeyPress(event) {
                  if (event.key === "Enter") {
                    sendMessage();
                  }
                }

                function sendMessage() {
                  const input = document.getElementById("messageInput");
                  const message = input.value.trim();

                  if (message) {
                    addMessage(message, true);
                    input.value = "";
                    showTypingIndicator();

                    setTimeout(() => {
                      hideTypingIndicator();
                      addMessage(
                        "I understand your message. How else can I help you?"
                      );
                    }, 1500);
                  }
                }

                // Add this new function after the existing JavaScript functions
                function handleCategoryClick(category) {
                  const categoryName = document
                    .querySelector(
                      `[onclick="handleCategoryClick('${category}')"]`
                    )
                    .textContent.trim();
                  addMessage(categoryName, true);
                  showTypingIndicator();

                  const categoryFAQs = {
                    documents: [
                      "Ilan po ang kailangang isubmit na set ng documents?",
                      "Ano po ang laman ng bawat set?",
                      "Saan po ilalagay ang mga sets?",
                      "Kailangan po ba ng ID photo? Ilan po?",
                    ],
                    forms: [
                      "Ano po ang minimum grade requirement para makapag-apply?",
                      "Kailangan po ba na computerized ang SPES Forms?",
                      "Ano po ang dapat isulat sa upper right corner ng Application Form?",
                      "Kailangan po bang isulat ang special skills sa form?",
                    ],
                    deadlines: [
                      "Kailan po ipapasa ang mga requirements?",
                      "Kailan po ang deadline ng final submission ng requirements?",
                      "Kailan po ang deadline ng pagsusumite ng physical copies ng requirements?",
                      "Saan po ipapasa ang mga physical copies ng requirements?",
                    ],
                    exam: [
                      "May second chance po ba o retake kung magkaproblema sa exam?",
                      "Kailan po malalaman ang schedule ng exam?",
                      "Kailan po lalabas ang resulta ng exam?",
                    ],
                    interview: [
                      "Kailan po ang schedule ng interview at pagsusumite ng physical copies ng requirements?",
                    ],
                  };

                  setTimeout(() => {
                    hideTypingIndicator();
                    const faqs = categoryFAQs[category];
                    let response = `<div class="faq-options">`;
                    faqs.forEach((faq) => {
                      response += `<button class="btn btn-sm btn-outline-primary m-1 faq-btn" onclick="handleFAQClick(this)">${faq}</button>`;
                    });
                    response += `<button class="btn btn-sm btn-outline-primary m-1 faq-btn agent-btn mt-3" onclick="handleAgentClick()">
                      <i class="bi bi-person-circle me-1"></i>Chat with a real agent
                    </button>`;
                    response += `</div>`;
                    addMessage(response);
                  }, 1500);
                }

                // Initial scroll to bottom when page loads
                window.addEventListener("load", () => {
                  // Add a small delay to ensure all content is loaded
                  setTimeout(scrollToBottom, 500);
                });

                // Add scroll event listener to handle manual scrolling
                const mainElement = document.querySelector("main");
                mainElement.addEventListener("scroll", () => {
                  // You can add additional scroll handling logic here if needed
                });

                // --- Messaging Frontend Integration ---
                let users = [];
                let activeUserId = null;
                let userChatRooms = {}; // Track chatRoom per user
                let userChatConnected = {}; // Track chatConnected per user

                function fetchUsers() {
                  fetch("/admin/messages/users")
                    .then((res) => res.json())
                    .then((data) => {
                      if (data.success) {
                        users = data.users;
                        renderUserList();
                        if (users.length > 0) {
                          selectUser(users[0].id);
                        } else {
                          document.getElementById(
                            "messagesContainer"
                          ).innerHTML =
                            '<div class="text-center text-muted mt-5">No users with messages yet.</div>';
                        }
                      }
                    });
                }

                function renderUserList() {
                  const userList = document.getElementById("userList");
                  userList.innerHTML = "";
                  users.forEach((user, idx) => {
                    const isPending = user.pending;
                    userList.innerHTML += `
                      <li class="list-group-item user-item${user.id === activeUserId ? ' active' : ''}${isPending ? ' list-group-item-warning' : ''}" onclick="selectUser(${user.id})">
                        <div class="d-flex align-items-center">
                          <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}" class="rounded-circle me-2" width="36" height="36" alt="User" />
                          <div>
                            <div class="fw-bold">${user.name}${isPending ? ' <span class=\"badge bg-warning text-dark ms-1\">Pending</span>' : ''}</div>
                            <div class="text-muted small">${user.role === 'new' || user.role === 'old' ? 'User' : user.role}</div>
                          </div>
                        </div>
                      </li>
                    `;
                  });
                }

                function selectUser(userId) {
                  activeUserId = userId;
                  renderUserList();
                  // Update chat header
                  const user = users.find(u => u.id === userId);
                  document.getElementById('chatUserName').textContent = user ? user.name : '';
                  document.getElementById('chatUserStatus').textContent = user ? (user.role === 'new' || user.role === 'old' ? 'User' : user.role) : '';
                  document.querySelector('.card-header img.rounded-circle').src = user ? `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}` : '';
                  // Reset chat state for this user
                  chatRoom = `chat_${userId}_${adminId}`;
                  socket.emit('join', { room: chatRoom });
                  chatConnected = userChatConnected[userId] || false;
                  fetchMessages(userId);
                }

                function fetchMessages(userId) {
                  const messagesContainer =
                    document.getElementById("messagesContainer");
                  messagesContainer.innerHTML =
                    '<div class="text-center text-muted mt-5">Loading messages...</div>';
                  fetch(`/admin/messages/history/${userId}`)
                    .then((res) => res.json())
                    .then((data) => {
                      if (data.success) {
                        renderMessages(data.messages);
                      } else {
                        messagesContainer.innerHTML =
                          '<div class="text-center text-danger mt-5">Failed to load messages.</div>';
                      }
                    });
                }

                function renderMessages(messages) {
                  const messagesContainer = document.getElementById("messagesContainer");
                  messagesContainer.innerHTML = "";
                  if (!messages.length) {
                    messagesContainer.innerHTML = '<div class="text-center text-muted mt-5">No messages yet.</div>';
                    return;
                  }
                  messages.forEach((msg) => {
                    if (msg.sender_id === adminId) {
                      // Admin message: right side
                      messagesContainer.innerHTML += `<div class='d-flex mb-3'><div class='user-message bg-primary text-white p-3 rounded ms-auto' style='max-width: 80%;'><p class='mb-0'>${msg.content}</p></div></div>`;
                    } else {
                      // Applicant message: left side
                      messagesContainer.innerHTML += `<div class='d-flex mb-3'><div class='bot-avatar me-2'><img src='/static/images/spes-logo.png' alt='Applicant' class='rounded-circle' style='width: 40px; height: 40px;'></div><div class='bot-message p-3 rounded' style='max-width: 80%;'><p class='mb-0'>${msg.content}</p></div></div>`;
                    }
                  });
                  scrollToBottom();
                }

                function sendMessage() {
                  const input = document.getElementById('messageInput');
                  const message = input.value.trim();
                  if (!message || !activeUserId) return;
                  // If this user has a pending request and admin types 'connect', accept the chat
                  const reqIdx = pendingRequests.findIndex(r => r.applicant_id === activeUserId);
                  if (reqIdx !== -1 && !chatConnected && message.toLowerCase() === 'connect') {
                    chatRoom = `chat_${activeUserId}_${adminId}`;
                    socket.emit('chat_accept', { applicant_id: activeUserId, admin_id: adminId, admin_name: adminName });
                    socket.emit('join', { room: chatRoom });
                    chatConnected = true;
                    userChatRooms[activeUserId] = chatRoom;
                    userChatConnected[activeUserId] = true;
                    pendingRequests.splice(reqIdx, 1);
                    // Remove pending highlight
                    let user = users.find(u => u.id === activeUserId);
                    if (user) { user.pending = false; renderUserList(); }
                    appendSystemMessage(`You are now connected with ${user ? user.name : 'the applicant'}.`);
                    input.value = '';
                    return;
                  }
                  // Send the message in the chat room if connected
                  socket.emit('send_message', {
                    sender_id: adminId,
                    receiver_id: activeUserId,
                    content: message,
                    room: chatRoom
                  });
                  input.value = '';
                }

                function appendSystemMessage(text) {
                  const messagesContainer = document.getElementById('messagesContainer');
                  messagesContainer.innerHTML += `<div class='d-flex mb-3'><div class='w-100 text-center text-secondary small'><em>${text}</em></div></div>`;
                  scrollToBottom();
                }

                window.addEventListener("load", fetchUsers);

                const socket = io();
                const adminId = {{ session['user_id']|tojson }};
                const adminName = {{ session['username']|tojson }};
                let pendingRequests = [];
                let chatRoom = null;
                let chatConnected = false;

                // Join admin room for notifications
                function joinAdminRoom() {
                  socket.emit('join', { room: 'admin_room' });
                }

                // Listen for chat requests
                socket.on('chat_request', data => {
                  // data: {applicant_id, applicant_name}
                  // Check if applicant is already in users
                  let user = users.find(u => u.id === data.applicant_id);
                  if (!user) {
                    // Add to users array
                    users.push({ id: data.applicant_id, name: data.applicant_name, role: 'new', pending: true });
                    renderUserList();
                  } else {
                    user.pending = true;
                    renderUserList();
                  }
                  pendingRequests.push(data);
                  // Show notification in the message box for this applicant
                  if (activeUserId === data.applicant_id) {
                    appendSystemMessage(`${data.applicant_name} wants to connect. Type 'connect' to start the chat.`);
                  }
                });

                socket.on('receive_message', function(data) {
                  if ((chatRoom && data.room === chatRoom) ||
                      (data.sender_id === adminId && data.receiver_id === activeUserId) ||
                      (data.sender_id === activeUserId && data.receiver_id === adminId)) {
                    appendMessage(data);
                  }
                });

                function appendMessage(msg) {
                  const messagesContainer = document.getElementById('messagesContainer');
                  if (msg.sender_id === adminId) {
                    // Admin message: right side
                    messagesContainer.innerHTML += `<div class='d-flex mb-3'><div class='user-message bg-primary text-white p-3 rounded ms-auto' style='max-width: 80%;'><p class='mb-0'>${msg.content}</p></div></div>`;
                  } else {
                    // Applicant message: left side
                    messagesContainer.innerHTML += `<div class='d-flex mb-3'><div class='bot-avatar me-2'><img src='/static/images/spes-logo.png' alt='Applicant' class='rounded-circle' style='width: 40px; height: 40px;'></div><div class='bot-message p-3 rounded' style='max-width: 80%;'><p class='mb-0'>${msg.content}</p></div></div>`;
                  }
                  scrollToBottom();
                }

                window.addEventListener('load', () => {
                  joinAdminRoom();
                });

                socket.on('chat_closed', data => {
                  if (chatRoom && data.room === chatRoom) {
                    appendSystemMessage(data.reason);
                    document.getElementById('messageInput').disabled = true;
                    chatConnected = false;
                    chatRoom = null;
                  }
                });
              </script>
            </div>
          </main>
          <!-- <footer class="row bg-light py-4 mt-auto">
            <div class="col">&copy SPES 2025 | All rights reserved.</div>
          </footer> -->
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
