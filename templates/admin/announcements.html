<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/static/images/spes-logo.png" type="image/png" />
    <title>DigiSPES - Announcements</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css"
    />
    <style>
      /* this is needed to make the content scrollable on larger screens */
      @media (min-width: 576px) {
        .h-sm-100 {
          height: 100%;
        }
      }

      .spes-logo-img {
        width: 50px;
      }
      #logo-name {
        margin-left: 0.5rem;
        font-size: 1.5rem;
        font-weight: bold;
      }
      #sidebar {
        box-shadow: 2px 4px 6px rgba(0, 0, 0, 0.1);
      }
      #card-body {
        background-color: #006edc;
        border-radius: 0.5rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .card-link {
        text-decoration: none;
        padding: 0.7rem 1rem;
        border-radius: 0.5rem;
        border: 1px solid white;
        background-color: white;

        &:hover {
          background-color: #006edc;
          color: white;
          border: 1px solid white;
        }
      }
      .main-container {
        background-color: rgb(239, 243, 255);
        padding: 1rem;
        border-radius: 0.25rem;
      }
      #sidebar-active {
        background-color: #006edc;
        color: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: background-color 0.3s ease, color 0.3s ease;
        padding: 0.5rem 0.5rem;
      }
    </style>
  </head>
  <body>
    <!-- sidebar boostrap 5-->

    <div class="container-fluid overflow-hidden">
      <div class="row vh-100 overflow-auto">
        <div
          class="col-12 col-sm-3 col-xl-2 px-sm-2 px-0 bg-white d-flex sticky-top"
        >
          <div
            class="d-flex flex-sm-column flex-row flex-grow-1 align-items-center align-items-sm-start px-3 pt-2 text-dark pb-2"
            id="sidebar"
          >
            <a
              href="/"
              class="d-flex align-items-center pb-sm-3 mb-md-0 me-md-auto text-dark text-decoration-none"
            >
              <span class="fs-5 mt-2"
                ><img
                  src="/static/images/spes-logo.png"
                  alt=""
                  srcset=""
                  class="spes-logo-img"
                /><span class="d-none d-sm-inline" id="logo-name"
                  >SPES</span
                ></span
              >
            </a>
            <ul
              class="nav nav-pills flex-sm-column flex-row flex-nowrap flex-shrink-1 flex-sm-grow-0 flex-grow-1 mb-sm-auto mb-0 justify-content-center align-items-center align-items-sm-start"
              id="menu"
            >
              <li>
                <a
                  href="{{ url_for('admin_dashboard') }}"
                  class="nav-link px-sm-0 px-2"
                >
                  <i class="fs-5 bi-speedometer2"></i
                  ><span class="ms-3 d-none d-sm-inline" id="">Dashboard</span>
                </a>
              </li>
              <li>
                <a href="#" class="nav-link px-sm-0 px-2">
                  <i class="fs-5 bi-megaphone"></i
                  ><span class="ms-3 d-none d-sm-inline" id="sidebar-active"
                    >Announcement</span
                  >
                </a>
              </li>
              <li>
                <a
                  href="{{ url_for('admin_applications') }}"
                  class="nav-link px-sm-0 px-2"
                >
                  <i class="fs-5 bi-file-earmark"></i
                  ><span class="ms-3 d-none d-sm-inline">Applicants</span>
                </a>
              </li>
              <!-- students who took the exam -->
              <li>
                <a
                  href="{{ url_for('admin_examinees') }}"
                  class="nav-link px-sm-0 px-2"
                >
                  <i class="fs-5 bi-people"></i
                  ><span class="ms-3 d-none d-sm-inline">Examinees</span>
                </a>
              </li>
              <li>
                <a
                  href="{{ url_for('admin_exams') }}"
                  class="nav-link px-sm-0 px-2"
                >
                  <i class="fs-5 bi-pencil"></i
                  ><span class="ms-3 d-none d-sm-inline">Exams</span>
                </a>
              </li>
              <li>
                <a href="#" class="nav-link px-sm-0 px-2">
                  <i class="fs-5 bi-people"></i
                  ><span class="ms-3 d-none d-sm-inline">Interview Panel</span>
                </a>
              </li>
              <li>
                <a
                  href="{{ url_for('admin_messages') }}"
                  class="nav-link px-sm-0 px-2"
                >
                  <i class="fs-5 bi-envelope"></i
                  ><span class="ms-3 d-none d-sm-inline" id="">Messages</span>
                </a>
              </li>
              <li>
                <a href="#" class="nav-link px-sm-0 px-2">
                  <i class="fs-5 bi-bell"></i
                  ><span class="ms-3 d-none d-sm-inline">Notifications</span>
                </a>
              </li>
              <li class="dropdown d-sm-none">
                <a
                  href="#"
                  class="nav-link dropdown-toggle px-sm-0 px-1"
                  id="dropdown"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  <i class="fs-5 bi-list"></i
                  ><span class="ms-3 d-none d-sm-inline"></span>
                </a>
                <ul
                  class="dropdown-menu dropdown-menu-dark text-small shadow"
                  aria-labelledby="dropdown"
                >
                  <li><a class="dropdown-item" href="#">Dashboard</a></li>
                  <li><a class="dropdown-item" href="#">Messages</a></li>
                  <li><a class="dropdown-item" href="#">Profile</a></li>
                  <li>
                    <hr class="dropdown-divider" />
                  </li>
                  <li>
                    <a class="dropdown-item" href="{{ url_for('logout') }}"
                      >Sign out</a
                    >
                  </li>
                </ul>
              </li>
            </ul>
            <div
              class="dropdown py-sm-4 mt-sm-auto ms-auto ms-sm-0 flex-shrink-1"
            >
              <a
                href="#"
                class="d-flex align-items-center text-dark text-decoration-none dropdown-toggle"
                id="dropdownUser1"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <i class="bi bi-person-circle fs-4"></i>
                <span class="d-none d-sm-inline mx-1">Admin</span>
              </a>
              <ul
                class="dropdown-menu dropdown-menu-dark text-small shadow"
                aria-labelledby="dropdownUser1"
              >
                <li><a class="dropdown-item" href="#">Settings</a></li>
                <li><a class="dropdown-item" href="#">Profile</a></li>
                <li>
                  <hr class="dropdown-divider" />
                </li>
                <li>
                  <a class="dropdown-item" href="{{ url_for('logout') }}"
                    >Sign out</a
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="col d-flex flex-column h-sm-100">
          <main class="row overflow-auto">
            <div class="col pt-4">
              <h3>Manage Announcements</h3>
              <hr />
              <div class="main-container">
                <div class="container py-4">
                  <div
                    class="d-flex justify-content-between align-items-center mb-3"
                  >
                    <h3>Announcements</h3>
                    <button
                      class="btn btn-primary"
                      data-bs-toggle="modal"
                      data-bs-target="#newAnnouncementModal"
                    >
                      <i class="bi bi-plus-circle me-2"></i>Post New
                      Announcement
                    </button>
                  </div>

                  <!-- Announcements List -->
                  <div class="card">
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table">
                          <thead>
                            <tr>
                              <th>Title</th>
                              <th>Type</th>
                              <th>Target Audience</th>
                              <th>Date Posted</th>
                              <th>Posted By</th>
                              <th>Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for announcement in announcements %}
                            <tr>
                              <td>{{ announcement.title }}</td>
                              <td>
                                <span
                                  class="badge {% if announcement.announcement_type == 'main' %}bg-primary{% else %}bg-info{% endif %}"
                                >
                                  {{ announcement.announcement_type|title }}
                                </span>
                              </td>
                              <td>
                                <span
                                  class="badge {% if announcement.target_audience == 'all' %}bg-success{% elif announcement.target_audience == 'new' %}bg-warning text-dark{% else %}bg-secondary{% endif %}"
                                >
                                  {{ announcement.target_audience|title }}
                                </span>
                              </td>
                              <td>{{ announcement.announcement_date }}</td>
                              <td>{{ announcement.admin_name }}</td>
                              <td>
                                <button
                                  class="btn btn-sm btn-primary"
                                  onclick="editAnnouncement({{ announcement.id }})"
                                >
                                  <i class="bi bi-pencil-square"></i>
                                </button>
                              </td>
                            </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </main>
          <footer class="row bg-light py-4 mt-auto">
            <div class="col">&copy SPES 2025 | All rights reserved.</div>
          </footer>
        </div>
      </div>
    </div>
    <!-- Modal -->
    <div
      class="modal fade"
      id="newAnnouncementModal"
      tabindex="-1"
      aria-labelledby="newAnnouncementModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="newAnnouncementModalLabel">
              Post New Announcement
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="announcementForm" enctype="multipart/form-data">
              <div class="mb-3">
                <label for="title" class="form-label">Title</label>
                <input
                  type="text"
                  class="form-control"
                  id="title"
                  name="title"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea
                  class="form-control"
                  id="description"
                  name="description"
                  rows="4"
                  required
                ></textarea>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="targetAudience" class="form-label"
                    >Target Audience</label
                  >
                  <select
                    class="form-select"
                    id="targetAudience"
                    name="targetAudience"
                    required
                  >
                    <option value="">Select Target Audience</option>
                    <option value="new">New Applicants</option>
                    <option value="old">Old Applicants</option>
                    <option value="all">All Applicants</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="announcementType" class="form-label"
                    >Announcement Type</label
                  >
                  <select
                    class="form-select"
                    id="announcementType"
                    name="announcementType"
                    required
                  >
                    <option value="">Select Type</option>
                    <option value="main">Main Announcement</option>
                    <option value="notification">Notification</option>
                  </select>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="submitAnnouncement()"
            >
              Post Announcement
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Edit Announcement Modal -->
    <div
      class="modal fade"
      id="editAnnouncementModal"
      tabindex="-1"
      aria-labelledby="editAnnouncementModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editAnnouncementModalLabel">
              Edit Announcement
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editAnnouncementForm">
              <input type="hidden" id="editAnnouncementId" />
              <div class="mb-3">
                <label for="editTitle" class="form-label">Title</label>
                <input
                  type="text"
                  class="form-control"
                  id="editTitle"
                  name="title"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editDescription" class="form-label"
                  >Description</label
                >
                <textarea
                  class="form-control"
                  id="editDescription"
                  name="description"
                  rows="4"
                  required
                ></textarea>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="editTargetAudience" class="form-label"
                    >Target Audience</label
                  >
                  <select
                    class="form-select"
                    id="editTargetAudience"
                    name="targetAudience"
                    required
                  >
                    <option value="">Select Target Audience</option>
                    <option value="new">New Applicants</option>
                    <option value="old">Old Applicants</option>
                    <option value="all">All Applicants</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="editAnnouncementType" class="form-label"
                    >Announcement Type</label
                  >
                  <select
                    class="form-select"
                    id="editAnnouncementType"
                    name="announcementType"
                    required
                  >
                    <option value="">Select Type</option>
                    <option value="main">Main Announcement</option>
                    <option value="notification">Notification</option>
                  </select>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-danger me-auto"
              onclick="deleteAnnouncement()"
            >
              Delete Announcement
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="updateAnnouncement()"
            >
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let currentAnnouncementId = null;

      function submitAnnouncement() {
        const form = document.getElementById("announcementForm");
        const formData = new FormData(form);

        fetch("/post-announcement", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert(data.message);
              location.reload();
            } else {
              alert(data.message);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("An error occurred while posting the announcement");
          });
      }

      function editAnnouncement(id) {
        currentAnnouncementId = id;
        console.log("Fetching announcement with ID:", id);

        const modal = document.getElementById("editAnnouncementModal");
        const modalBody = modal.querySelector(".modal-body");
        const form = document.getElementById("editAnnouncementForm");

        // Show loading state while preserving form structure
        form.style.display = "none";
        const loadingDiv = document.createElement("div");
        loadingDiv.className = "text-center";
        loadingDiv.innerHTML =
          '<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>';
        modalBody.insertBefore(loadingDiv, form);

        // Show the modal first
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();

        // Fetch announcement details
        fetch(`/get-announcement/${id}`)
          .then((response) => {
            console.log("Response status:", response.status);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            console.log("Received data:", data);
            // Remove loading spinner
            loadingDiv.remove();
            form.style.display = "block";

            if (data.success && data.announcement) {
              const announcement = data.announcement;
              document.getElementById("editAnnouncementId").value =
                announcement.id;
              document.getElementById("editTitle").value = announcement.title;
              document.getElementById("editDescription").value =
                announcement.description;
              document.getElementById("editTargetAudience").value =
                announcement.target_audience;
              document.getElementById("editAnnouncementType").value =
                announcement.announcement_type;
            } else {
              form.style.display = "none";
              const errorDiv = document.createElement("div");
              errorDiv.className = "alert alert-danger";
              errorDiv.setAttribute("role", "alert");
              errorDiv.textContent =
                data.message || "Failed to load announcement details";
              modalBody.insertBefore(errorDiv, form);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            // Remove loading spinner
            loadingDiv.remove();
            form.style.display = "none";

            const errorDiv = document.createElement("div");
            errorDiv.className = "alert alert-danger";
            errorDiv.setAttribute("role", "alert");
            errorDiv.innerHTML = `An error occurred while fetching announcement details. Please try again.<br><small>Error details: ${error.message}</small>`;
            modalBody.insertBefore(errorDiv, form);
          });
      }

      function updateAnnouncement() {
        if (!currentAnnouncementId) {
          alert("No announcement selected");
          return;
        }

        const form = document.getElementById("editAnnouncementForm");
        const formData = new FormData(form);
        formData.append("id", currentAnnouncementId);

        fetch("/update-announcement", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert(data.message);
              location.reload();
            } else {
              alert(data.message || "Failed to update announcement");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("An error occurred while updating the announcement");
          });
      }

      function deleteAnnouncement() {
        if (!currentAnnouncementId) {
          alert("No announcement selected");
          return;
        }

        if (confirm("Are you sure you want to delete this announcement?")) {
          fetch(`/delete-announcement/${currentAnnouncementId}`, {
            method: "POST",
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                alert(data.message);
                location.reload();
              } else {
                alert(data.message || "Failed to delete announcement");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("An error occurred while deleting the announcement");
            });
        }
      }
    </script>
  </body>
</html>
